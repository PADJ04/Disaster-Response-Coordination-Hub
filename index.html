<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Disaster Routing - Bridge Avoidance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif}
    #map{height:100vh}
    .panel{position:absolute;left:10px;top:10px;z-index:1000;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);width:260px}
    .panel button{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:0;background:#1976d2;color:#fff;cursor:pointer}
    .panel button.warn{background:#d32f2f}
    .panel select{width:100%;padding:6px;border-radius:6px;margin-top:6px}
    .small{font-size:13px;color:#333;margin-top:6px}
  </style>
</head>
<body>

<div class="panel">
  <strong>ðŸš¨ Disaster Routing â€” Bridge Avoidance</strong>
  <div style="margin-top:8px">
    <button id="setStart">Set Start (click map)</button>
    <button id="setEnd">Set End (click map)</button>
    <button id="toggleBlock" class="warn">Toggle Block Bridge</button>
    <button id="calcRoute">Calculate Route (avoid if blocked)</button>
    <button id="clear">Clear</button>
  </div>
  <div class="small">Profile
    <select id="profile"><option value="car">car</option><option value="foot">foot</option></select>
  </div>
  <div id="info" class="small"></div>
</div>

<div id="map"></div>

<script>
  // --- map setup
  const map = L.map('map').setView([15.434,75.013], 15);
  // Base layers
const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
});

// Satellite layer (Esri World Imagery)
const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 19,
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics'
});

streetLayer.addTo(map);

// Layer control to switch views
const baseLayers = {
  "Street View": streetLayer,
  "Satellite View": satelliteLayer
};

L.control.layers(baseLayers).addTo(map);

  // --- state
  let mode = null; // 'start' or 'end'
  let startMarker=null, endMarker=null, routeLine=null;
  let bridgeBlocked=false;
  let bridgeLayer=null;

  // Bridge line endpoints (lat,lon)
  const bridgeStart = [15.435741,75.010975];
  const bridgeEnd   = [15.436248,75.011394];

  // Create a rectangular polygon around the bridge (simple buffer) - it's lat,lng points for Leaflet
  const bridgePolyLatLng = [
    [15.435491,75.010745],
    [15.435998,75.011624],
    [15.436498,75.012043],
    [15.435991,75.011164]
  ];

  // Draw the bridge polygon (visual only)
  function drawBridgeVisual(){
    if(bridgeLayer) map.removeLayer(bridgeLayer);
    bridgeLayer = L.polygon(bridgePolyLatLng, {color:'red',fillColor:'#f44336',fillOpacity:0.35}).addTo(map).bindPopup('Bridge (toggle block to avoid)');
  }
  drawBridgeVisual();

  // Helpers to set start/end
  document.getElementById('setStart').onclick = ()=>{ mode='start'; alert('Click on map to place START'); };
  document.getElementById('setEnd').onclick   = ()=>{ mode='end';   alert('Click on map to place END'); };

  map.on('click', e=>{
    if(!mode) return;
    if(mode==='start'){
      if(startMarker) map.removeLayer(startMarker);
      startMarker = L.marker(e.latlng,{title:'Start'}).addTo(map).bindPopup('Start').openPopup();
    }
    if(mode==='end'){
      if(endMarker) map.removeLayer(endMarker);
      endMarker = L.marker(e.latlng,{title:'End'}).addTo(map).bindPopup('End').openPopup();
    }
    mode=null;
  });

  // Toggle blocked bridge flag and update visual
  document.getElementById('toggleBlock').onclick = ()=>{
    bridgeBlocked = !bridgeBlocked;
    document.getElementById('toggleBlock').textContent = bridgeBlocked? 'Unblock Bridge' : 'Block Bridge';
    drawBridgeVisual();
    if(bridgeBlocked){ bridgeLayer.setStyle({color:'#b71c1c',fillColor:'#b71c1c',fillOpacity:0.4}); }
    else { bridgeLayer.setStyle({color:'red',fillColor:'#f44336',fillOpacity:0.35}); }
  };

  // Clear everything
  document.getElementById('clear').onclick = ()=>{
    if(startMarker) map.removeLayer(startMarker);
    if(endMarker) map.removeLayer(endMarker);
    if(routeLine) map.removeLayer(routeLine);
    startMarker = endMarker = routeLine = null;
    document.getElementById('info').innerHTML = '';
  };

  // Build GeoJSON polygon in lon,lat order (GraphHopper expects [lon,lat])
  function buildBridgeGeoJSON(){
    // Use the same polygon corners but as [lon,lat]
    return {
      type: 'Feature',
      geometry: {
        type: 'Polygon',
        coordinates: [[
          [75.010745,15.435491],
          [75.011624,15.435998],
          [75.012043,15.436498],
          [75.011164,15.435991],
          [75.010745,15.435491]
        ]]
      }
    };
  }

  // Compute route
  document.getElementById('calcRoute').onclick = async ()=>{
    if(!startMarker || !endMarker){ alert('Place start and end first'); return; }
    const s = startMarker.getLatLng();
    const e = endMarker.getLatLng();
    const profile = document.getElementById('profile').value;

    // Build request body
    const body = {
      profile: profile,
      points: [ [s.lng, s.lat], [e.lng, e.lat] ], // GraphHopper uses lon,lat in points array
      points_encoded: false
    };

    if(bridgeBlocked){
      body.custom_model = {
        areas: { bridge_block: buildBridgeGeoJSON() },
        priority: [{ if: 'in_bridge_block', multiply_by: 0 }]
      };
    }

    // If your server still has CH enabled globally you can add ch.disable=true as a query param
    const url = 'http://localhost:8989/route?';
    const params = new URLSearchParams({ profile: profile, points_encoded: 'false' });
    // include ch.disable if needed (safe to include)
    params.set('ch.disable', 'true');

    try{
      const res = await fetch(url + params.toString(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if(!res.ok){
        const txt = await res.text();
        alert('Routing error: ' + res.status + ' â€” ' + txt);
        return;
      }

      const data = await res.json();
      if(!data.paths || !data.paths.length){ alert('No route found'); return; }

      if(routeLine) map.removeLayer(routeLine);
      const coords = data.paths[0].points.coordinates.map(c => [c[1], c[0]]);
      routeLine = L.polyline(coords, {color:'#1e88e5', weight:5}).addTo(map);
      map.fitBounds(routeLine.getBounds(), {padding:[40,40]});

      const km = (data.paths[0].distance/1000).toFixed(2);
      const mins = (data.paths[0].time/60000).toFixed(1);
      document.getElementById('info').innerHTML = `<strong>Distance:</strong> ${km} km Â· <strong>ETA:</strong> ${mins} min`;

    }catch(err){
      alert('Network or server error: ' + err.message);
    }
  };

</script>

</body>
</html>